
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="MOE STUDIO - 萌の軌跡・願いの叶う場所">
    <title>使用SO库时要注意的一些问题 - MOE STUDIO - 萌の軌跡・願いの叶う場所</title>
    <meta name="author" content="Kaede Akatsuki">
    
    
        <link rel="icon" href="http://kaedea.com/assets/images/favicon2.png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="正好动态加载系列文章谈到了加载SO库的地方，我觉得这里可以顺便谈谈使用SO库时需要注意的一些问题。或许这些问题对于经常和SO库开发打交道的同学来说已经是老生长谈，但是既然要讨论一整个动态加载系列，我想还是有必要说说使用SO库时的一些问题。
在项目里使用SO库非常简单，在 加载SD卡中的SO库 中也有谈到，只需要把需要用到的SO库拷贝进 jniLibs(或者Eclipse项目里面的libs) 中，然">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用SO库时要注意的一些问题">
<meta property="og:url" content="http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/index.html">
<meta property="og:site_name" content="MOE STUDIO - 萌の軌跡・願いの叶う場所">
<meta property="og:description" content="正好动态加载系列文章谈到了加载SO库的地方，我觉得这里可以顺便谈谈使用SO库时需要注意的一些问题。或许这些问题对于经常和SO库开发打交道的同学来说已经是老生长谈，但是既然要讨论一整个动态加载系列，我想还是有必要说说使用SO库时的一些问题。
在项目里使用SO库非常简单，在 加载SD卡中的SO库 中也有谈到，只需要把需要用到的SO库拷贝进 jniLibs(或者Eclipse项目里面的libs) 中，然">
<meta property="og:updated_time" content="2016-06-10T15:14:49.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用SO库时要注意的一些问题">
<meta name="twitter:description" content="正好动态加载系列文章谈到了加载SO库的地方，我觉得这里可以顺便谈谈使用SO库时需要注意的一些问题。或许这些问题对于经常和SO库开发打交道的同学来说已经是老生长谈，但是既然要讨论一整个动态加载系列，我想还是有必要说说使用SO库时的一些问题。
在项目里使用SO库非常简单，在 加载SD卡中的SO库 中也有谈到，只需要把需要用到的SO库拷贝进 jniLibs(或者Eclipse项目里面的libs) 中，然">
<meta name="twitter:creator" content="@kidhaibara">
    
        <meta rel="publisher" content="https://plus.google.com/113775988407213380000"/>
    
    
        
    
    
        <meta property="og:image" content="http://kaedea.com/assets/images/avatar_01.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-27vrduj1jopliavvnzi7ibndpmbvg7lzo4a2uswrsi4m5vwauf2qi8s1v3or.min.css" type="text/css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">MOE STUDIO - 萌の軌跡・願いの叶う場所</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/#search">
        
        
            <i class="fa fa-lg fa-search"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar_01.png"/>
            </a>
            <span class="sidebar-profile-name">Kaede Akatsuki</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-circle-thin"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-star-o"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bars"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-terminal"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/kaedea" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/link"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-at"></i>
                    <span class="sidebar-button-desc">Links</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title" itemprop="headline">
            使用SO库时要注意的一些问题
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sat Jun 04 2016 00:00:00 GMT+0800">
	
		    Jun 04, 2016
    	
    </time>
    
        <span>IN </span>
        
    <a class="category-link" href="/categories/Android/">Android</a>, <a class="category-link" href="/categories/Android/动态加载/">动态加载</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>正好动态加载系列文章谈到了加载SO库的地方，我觉得这里可以顺便谈谈使用SO库时需要注意的一些问题。或许这些问题对于经常和SO库开发打交道的同学来说已经是老生长谈，但是既然要讨论一整个动态加载系列，我想还是有必要说说使用SO库时的一些问题。</p>
<p>在项目里使用SO库非常简单，在 <a href="/#">加载SD卡中的SO库</a> 中也有谈到，只需要把需要用到的SO库拷贝进 <strong>jniLibs(或者Eclipse项目里面的libs)</strong> 中，然后在JAVA代码中调用 <strong>System.loadLibrary(“xxx”)</strong> 加载对应的SO库，就可以使用JNI语句调用SO库里面的Native方法了。</p>
<p>但是有同学注意到了，SO库文件可以随便改文件名，却不能任意修改文件夹路径，而是“armeabi”、“armeabi-v7a”、“x86”等文件夹名有着严格的要求，这些文件夹名有什么意义么？<br><a id="more"></a></p>
<h2 id="SO_u5E93_u7C7B_u578B_u548CCPU_u67B6_u6784_u7C7B_u578B"><a href="#SO_u5E93_u7C7B_u578B_u548CCPU_u67B6_u6784_u7C7B_u578B" class="headerlink" title="SO库类型和CPU架构类型"></a>SO库类型和CPU架构类型</h2><p>原因很简单，不同CPU架构的设备需要用不同类型SO库（从文件名也可以猜出来个大概嘛 ╮(￣▽￣”)╭）。</p>
<p>记得还在学校的时候，提及ARM处理器时，老师说以后移动设备的CPU基本就是ARM类型的了。老师不曾欺我，早期的Android系统几乎只支持ARM的CPU架构，不过现在至少支持以下七种不同的CPU架构：ARMv5，ARMv7，x86，MIPS，ARMv8，MIPS64和x86_64。每一种CPU类型都对应一种ABI（Application Binary Interface），“armeabi-v7a”文件夹前面的“armeabi”指的就是ARM这种类型的ABI，后面的“v7a”指的是ARMv7。这7种CPU类型对应的SO库的文件夹名是：armeabi，armeabi-v7a，x86，mips，arm64-v8a，mips64，x86_64。</p>
<p>不同类型的移动设备在运行APP时，需要加载自己支持的类型的SO库，不然就GG了。通过 <strong>Build.SUPPORTED_ABIS</strong> 我们可以判断当前设备支持的ABI，不过一般情况下，不需要开发者自己去判断ABI，Android系统在安装APK的时候，不会安装APK里面全部的SO库文件，而是会根据当前CPU类型支持的ABI，从APK里面拷贝最合适的SO库，并保存在APP的内部存储路径的 <strong>libs</strong> 下面。（这里说一般情况，是因为有例外的情况存在，比如我们动态加载外部的SO库的时候，就需要自己判断ABI类型了。）</p>
<blockquote>
<p>一种CPU架构　=　一种对应的ABI参数　=　 一种对应类型的SO库</p>
</blockquote>
<p>到这里，我们发现使用SO库的逻辑还是比较简单的，但是Android系统加载SO库的逻辑还是给我们留下了一些坑。</p>
<h2 id="u4F7F_u7528SO_u5E93_u65F6_u8981_u6CE8_u610F_u7684_u4E00_u4E9B_u95EE_u9898"><a href="#u4F7F_u7528SO_u5E93_u65F6_u8981_u6CE8_u610F_u7684_u4E00_u4E9B_u95EE_u9898" class="headerlink" title="使用SO库时要注意的一些问题"></a>使用SO库时要注意的一些问题</h2><h3 id="1-__u522B_u628ASO_u5E93_u653E_u9519_u5730_u65B9"><a href="#1-__u522B_u628ASO_u5E93_u653E_u9519_u5730_u65B9" class="headerlink" title="1. 别把SO库放错地方"></a>1. 别把SO库放错地方</h3><p>SO库其实都是APP运行时加载的，也就是说APP只有在运行的时候才知道SO库文件的存在，这就无法通过静态代码检查或者在编译APP时检查SO库文件是否正常。所以，Android开发对SO库的存放路径有严格的要求。</p>
<p>使用SO库的时候，除了“armeabi-v7a”等文件夹名需要严格按照规定的来自外，SO库要放在项目的哪个文件夹下也要按照套路来，以下是一些总结：</p>
<ul>
<li>Android Studio 工程放在 <strong>jniLibs/xxxabi</strong> 目录中（当然也可以通过在build.gradle文件中的设置jniLibs.srcDir属性自己指定）；</li>
<li>Eclipse 工程放在 <strong>libs/xxxabi</strong> 目录中（这也是使用ndk-build命令生成SO库的默认目录）；</li>
<li>aar 依赖包中位于 <strong>jni/ABI</strong> 目录中（SO库会自动包含到引用AAR压缩包到APK中）；</li>
<li>最终构建出来的APK文件中，SO库存在 <strong>lib/xxxabi</strong> 目录中（也就是说无论你用什么方式构建，只要保证APK包里SO库的这个路径没错就没问题）；</li>
<li>通过 PackageManager 安装后，在小于 Android 5.0 的系统中，SO库位于 APP 的 <strong>nativeLibraryPath</strong> 目录中；在大于等于 Android 5.0 的系统中，SO库位于 APP 的 <strong>nativeLibraryRootDir/CPU_ARCH</strong> 目录中；</li>
</ul>
<p>既然扯到了这里，顺便说一下，我在使用 Android Studio 1.5 构建APK的时候，发现 Gradle 插件只会默认打包application类型的module的jniLibs下面的SO库文件，而不会打包aar依赖包的SO库，所以会导致最终构建出来的APK里的SO库文件缺失。暂时的解决方案是把所有的SO库都放在application模块中（这显然不是很好的解决方案），不知道这是不是Studio的BUG，同事的解决方案是通过修改Gradle插件来增加对aar依赖包的SO库的打包支持（GitHub有开源的第三方Gradle插件项目，使用Java和Groovy语言开发）。</p>
<h3 id="2-__u5C3D_u53EF_u80FD_u63D0_u4F9BCPU_u652F_u6301_u7684_u6700_u4F18SO_u5E93"><a href="#2-__u5C3D_u53EF_u80FD_u63D0_u4F9BCPU_u652F_u6301_u7684_u6700_u4F18SO_u5E93" class="headerlink" title="2. 尽可能提供CPU支持的最优SO库"></a>2. 尽可能提供CPU支持的最优SO库</h3><p>当一个应用安装在设备上，只有该设备支持的CPU架构对应的SO库会被安装。但是，有时候，设备支持的SO库类型不止一种，比如大多的X86设备除了支持X86类型的SO库，还兼容ARM类型的SO库（目前应用市场上大部分的APP只适配了ARM类型的SO库，X86类型的设备如果不能兼容ARM类型的SO库的话，大概要嗝屁了吧）。</p>
<p>所以如果你的APK只适配了ARM类型的SO库的话，还是能以兼容的模式在X86类型的设备上运行（比如华硕的平板），但是这不意味着你就不用适配X86类型的SO库了，因为X86的CPU使用兼容模式运行ARM类型的SO库会异常卡顿（试着回想几年前你开始学习Android开发的时候，在PC上使用AVD模拟器的那种感觉）。</p>
<h3 id="3-__u6CE8_u610FSO_u5E93_u7684_u7F16_u8BD1_u7248_u672C"><a href="#3-__u6CE8_u610FSO_u5E93_u7684_u7F16_u8BD1_u7248_u672C" class="headerlink" title="3. 注意SO库的编译版本"></a>3. 注意SO库的编译版本</h3><p>除了要注意使用了正确CPU类型的SO库，也要注意SO库的编译版本的问题。虽然现在的Android Studio支持在项目中直接编译SO库，但是更多的时候我们还是选择使用事先编译好的SO库，这时就要注意了，编译APK的时候，我们总是希望使用最新版本的build-tools来编译，因为Android SDK最新版本会帮我们做出最优的向下兼容工作。</p>
<p>但是这对于编译SO库来说就不一样了，因为NDK平台不是向下兼容的，而是向上兼容的。应该使用app的minSdkVersion对应的版本的NDK标本来编译SO库文件，如果使用了太高版本的NDK，可能会导致APP性能低下，或者引发一些SO库相关的运行时异常，比如“UnsatisfiedLinkError”，“dlopen: failed”以及其他类型的Crash。</p>
<p>一般情况下，我们都是使用编译好的SO库文件，所以当你引入一个预编译好的SO库时，你需要检查它被编译所用的平台版本。</p>
<h3 id="4-__u5C3D_u53EF_u80FD_u4E3A_u6BCF_u79CDCPU_u7C7B_u578B_u90FD_u63D0_u4F9B_u5BF9_u5E94_u7684SO_u5E93"><a href="#4-__u5C3D_u53EF_u80FD_u4E3A_u6BCF_u79CDCPU_u7C7B_u578B_u90FD_u63D0_u4F9B_u5BF9_u5E94_u7684SO_u5E93" class="headerlink" title="4. 尽可能为每种CPU类型都提供对应的SO库"></a>4. 尽可能为每种CPU类型都提供对应的SO库</h3><p>比如有时候，因为业务的需求，我们的APP不需要支持AMR64的设备，但这不意味着我们就不用编译ARM64对应的SO库。举个例子，我们的APP只支持armeabi-v7a和x86架构，然后我们的APP使用了一个第三方的Library，而这个Library提供了AMR64等更多类型CPU架构的支持，构建APK的时候，这些ARM64的SO库依然会被打包进APK里面，也就是说我们自己的SO库没有对应的ARM64的SO库，而第三方的Library却有。这时候，某些ARM64的设备安装该APK的时候，发现我们的APK里带有ARM64的SO库，会误以为我们的APP已经做好了AMR64的适配工作，所以只会选择安装APK里面ARM64类型的SO库，这样会导致我们自己项目的SO库没有被正确安装（虽然armeabi-v7a和x86类型的SO库确实存在APK包里面）。</p>
<p>这时正确的做法是，给我们自己的SO库也提供AMR64支持，或者不打包第三方Library项目的ARM64的SO库。使用第二种方案时，可以把APK里面不需要支持的ABI文件夹给删除，然后重新打包，而在Android Studio下，则可以通过以下的构建方式指定需要类型的SO库。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">    flavor1 &#123;</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters <span class="string">"armeabi-v7a"</span></span><br><span class="line">            abiFilters <span class="string">"x86"</span></span><br><span class="line">            abiFilters <span class="string">"armeabi"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    flavor2 &#123;</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters <span class="string">"armeabi-v7a"</span></span><br><span class="line">            abiFilters <span class="string">"x86"</span></span><br><span class="line">            abiFilters <span class="string">"armeabi"</span></span><br><span class="line">            abiFilters <span class="string">"arm64-v8a"</span></span><br><span class="line">            abiFilters <span class="string">"x86_64"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要说明的是，如果我们的项目是SDK项目，我们最好提供全平台类型的SO库支持，因为APP能支持的设备CPU类型的数量，就是项目中所有SO库支持的最少CPU类型的数量（使用我们SDK的APP能支持的CPU类型只能少于等于我们SDK支持的类型）。</p>
<h3 id="5-__u4E0D_u8981_u901A_u8FC7_u201C_u51CF_u5C11_u5176_u4ED6CPU_u7C7B_u578B_u652F_u6301_u7684SO_u5E93_u201D_u6765_u51CF_u5C11APK_u7684_u4F53_u79EF"><a href="#5-__u4E0D_u8981_u901A_u8FC7_u201C_u51CF_u5C11_u5176_u4ED6CPU_u7C7B_u578B_u652F_u6301_u7684SO_u5E93_u201D_u6765_u51CF_u5C11APK_u7684_u4F53_u79EF" class="headerlink" title="5. 不要通过“减少其他CPU类型支持的SO库”来减少APK的体积"></a>5. 不要通过“减少其他CPU类型支持的SO库”来减少APK的体积</h3><p>确实，所有的x86/x86_64/armeabi-v7a/arm64-v8a设备都支持armeabi架构的SO库，因此似乎移除其他ABIs的SO库是一个减少APK大小的好办法。但事实上并不是，这不只影响到函数库的性能和兼容性。</p>
<p>X86设备能够很好的运行ARM类型函数库，但并不保证100%不发生crash，特别是对旧设备，兼容只是一种保底方案。64位设备（arm64-v8a, x86_64, mips64）能够运行32位的函数库，但是以32位模式运行，在64位平台上运行32位版本的ART和Android组件，将丢失专为64位优化过的性能（ART，webview，media等等）。</p>
<p>过减少其他CPU类型支持的SO库来减少APK的体积不是很明智的做法，如果真的需要通过减少SO库来做APK瘦身，我们也有其他办法。</p>
<h2 id="u51CF_u5C11SO_u5E93_u4F53_u79EF_u7684_u6B63_u786E_u59FF_u52BF"><a href="#u51CF_u5C11SO_u5E93_u4F53_u79EF_u7684_u6B63_u786E_u59FF_u52BF" class="headerlink" title="减少SO库体积的正确姿势"></a>减少SO库体积的正确姿势</h2><h3 id="1-__u6784_u5EFA_u7279_u5B9AABI_u652F_u6301_u7684APK"><a href="#1-__u6784_u5EFA_u7279_u5B9AABI_u652F_u6301_u7684APK" class="headerlink" title="1. 构建特定ABI支持的APK"></a>1. 构建特定ABI支持的APK</h3><p>我们可以构建一个APK，它支持所有的CPU类型。但是反过来，我们可以为每个CPU类型都单独构建一个APK，然后不同CPU类型的设备安装对应的APK即可，当然前提是应用市场得提供用户设备CPU类型设别的支持，就目前来说，至少PLAY市场是支持的。</p>
<p>Gradle可以通过以下配置生成不同ABI支持的APK（引用自别的文章，没实际使用过）：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    splits &#123;</span><br><span class="line">        abi &#123;</span><br><span class="line">            enable <span class="literal">true</span></span><br><span class="line">            reset()</span><br><span class="line">            include <span class="string">'x86'</span>, <span class="string">'x86_64'</span>, <span class="string">'armeabi-v7a'</span>, <span class="string">'arm64-v8a'</span> <span class="comment">//select ABIs to build APKs for</span></span><br><span class="line">            universalApk <span class="literal">true</span> <span class="comment">//generate an additional APK that contains all the ABIs</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// map for the version code</span></span><br><span class="line">    project.ext.versionCodes = [<span class="string">'armeabi'</span>: <span class="number">1</span>, <span class="string">'armeabi-v7a'</span>: <span class="number">2</span>, <span class="string">'arm64-v8a'</span>: <span class="number">3</span>, <span class="string">'mips'</span>: <span class="number">5</span>, <span class="string">'mips64'</span>: <span class="number">6</span>, <span class="string">'x86'</span>: <span class="number">8</span>, <span class="string">'x86_64'</span>: <span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        <span class="comment">// assign different version code for each output</span></span><br><span class="line">        variant.outputs.each &#123; output -&gt;</span><br><span class="line">            output.versionCodeOverride =</span><br><span class="line">                    project.ext.versionCodes.get(output.getFilter(com.android.build.OutputFile.ABI), <span class="number">0</span>) * <span class="number">1000000</span> + android.defaultConfig.versionCode</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-__u4ECE_u7F51_u7EDC_u4E0B_u8F7D_u5F53_u524D_u8BBE_u5907_u652F_u6301_u7684SO_u5E93"><a href="#2-__u4ECE_u7F51_u7EDC_u4E0B_u8F7D_u5F53_u524D_u8BBE_u5907_u652F_u6301_u7684SO_u5E93" class="headerlink" title="2. 从网络下载当前设备支持的SO库"></a>2. 从网络下载当前设备支持的SO库</h3><p>说到这里，总算回到动态加载的主题了。⊙﹏⊙</p>
<p>使用Android的动态加载技术，可以加载外部的SO库，所以我们可以从网络下载SO库文件并加载了。我们可以下载所有类型的SO库文件，然后加载对应类型的SO库，也可以下载对应类型的SO库然后加载，不过无论哪种方式，我们最好都在加载SO库前，对SO库文件的类型做一下判断。</p>
<p>我个人的方案是，存储在服务器的SO库依然按照APK包的压缩方式打包，也就是，SO库存放在APK包的 <strong>libs/xxxabi</strong> 路径下面，下载完带有SO库的APK包后，我们可以遍历libs路径下的所有SO库，选择加载对应类型的SO库。</p>
<p>具体实现代码看上去像是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 将一个SO库复制到指定路径，会先检查改SO库是否与当前CPU兼容</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> sourceDir     SO库所在目录</span><br><span class="line"> * <span class="doctag">@param</span> so            SO库名字</span><br><span class="line"> * <span class="doctag">@param</span> destDir       目标根目录</span><br><span class="line"> * <span class="doctag">@param</span> nativeLibName 目标SO库目录名</span><br><span class="line"> * <span class="doctag">@return</span></span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">copySoLib</span><span class="params">(File sourceDir, String so, String destDir, String nativeLibName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isSuccess = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LogUtil.d(TAG, <span class="string">"[copySo] 开始处理so文件"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">            String[] abis = Build.SUPPORTED_ABIS;</span><br><span class="line">            <span class="keyword">if</span> (abis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String abi : abis) &#123;</span><br><span class="line">                    LogUtil.d(TAG, <span class="string">"[copySo] try supported abi:"</span> + abi);</span><br><span class="line">                    String name = <span class="string">"lib"</span> + File.separator + abi + File.separator + so;</span><br><span class="line">                    File sourceFile = <span class="keyword">new</span> File(sourceDir, name);</span><br><span class="line">                    <span class="keyword">if</span> (sourceFile.exists()) &#123;</span><br><span class="line">                        LogUtil.i(TAG, <span class="string">"[copySo] copy so: "</span> + sourceFile.getAbsolutePath());</span><br><span class="line">                        isSuccess = FileUtil.copyFile(sourceFile.getAbsolutePath(), destDir + File.separator + nativeLibName + File.separator + so);</span><br><span class="line">                        <span class="comment">//api21 64位系统的目录可能有些不同</span></span><br><span class="line">                        <span class="comment">//copyFile(sourceFile.getAbsolutePath(), destDir + File.separator +  name);</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LogUtil.e(TAG, <span class="string">"[copySo] get abis == null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtil.d(TAG, <span class="string">"[copySo] supported api:"</span> + Build.CPU_ABI + <span class="string">" "</span> + Build.CPU_ABI2);</span><br><span class="line"></span><br><span class="line">            String name = <span class="string">"lib"</span> + File.separator + Build.CPU_ABI + File.separator + so;</span><br><span class="line">            File sourceFile = <span class="keyword">new</span> File(sourceDir, name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!sourceFile.exists() &amp;&amp; Build.CPU_ABI2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                name = <span class="string">"lib"</span> + File.separator + Build.CPU_ABI2 + File.separator + so;</span><br><span class="line">                sourceFile = <span class="keyword">new</span> File(sourceDir, name);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!sourceFile.exists()) &#123;</span><br><span class="line">                    name = <span class="string">"lib"</span> + File.separator + <span class="string">"armeabi"</span> + File.separator + so;</span><br><span class="line">                    sourceFile = <span class="keyword">new</span> File(sourceDir, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sourceFile.exists()) &#123;</span><br><span class="line">                LogUtil.i(TAG, <span class="string">"[copySo] copy so: "</span> + sourceFile.getAbsolutePath());</span><br><span class="line">                isSuccess = FileUtil.copyFile(sourceFile.getAbsolutePath(), destDir + File.separator + nativeLibName + File.separator + so);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">            LogUtil.e(TAG, <span class="string">"[copySo] 安装 "</span> + so + <span class="string">" 失败 : NO_MATCHING_ABIS"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"install "</span> + so + <span class="string">" fail : NO_MATCHING_ABIS"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><ol>
<li>一种CPU架构 = 一种ABI = 一种对应的SO库；</li>
<li>加载SO库时，需要加载对应类型的SO库；</li>
<li>尽量提供全平台CPU类型的SO库支持；</li>
</ol>
<p>题外话，SO库的使用本身就是一种最纯粹的动态加载技术，SO库本身不参与APK的编译过程，使用JNI调用SO库里的Native方法的方式看上去也像是一种“硬编程”，Native方法看上去与一般的Java静态方法没什么区别，但是它的具体实现却是可以随时动态更换的（更换SO库就好），这也可以用来实现热修复的方案，与Java方法一旦加载进内存就无法再次更换不同，Native方法不需要重启APP就可以随意更换。</p>
<p>出于安全和生态控制的原因，Google Play市场不允许APP有加载外部可执行文件的行为，一旦你的APK里被检查出有额外的可执行文件时就不好玩了，所以现在许多APP都偷偷把用于动态加载的可执行文件的后缀名换成“.so”，这样被发现的几率就降低了，因为加载SO库看上去就是官方合法版本的动态加载啊（不然SO库怎么工作），虽然这么做看起来有点掩耳盗铃。</p>
<h2 id="u53C2_u8003_u6587_u7AE0"><a href="#u53C2_u8003_u6587_u7AE0" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a href="http://www.jianshu.com/p/cb05698a1968" target="_blank" rel="external">关于Android的.so文件你所需要知道的</a></li>
<li><a href="https://github.com/limpoxe/Android-Plugin-Framework" target="_blank" rel="external">Android-Plugin-Framework</a></li>
</ul>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Android/">Android</a> <a class="tag tag--primary tag--small t-link" href="/tags/SO库/">SO库</a> <a class="tag tag--primary tag--small t-link" href="/tags/动态加载/">动态加载</a> <a class="tag tag--primary tag--small t-link" href="/tags/插件化/">插件化</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/04/android-dynamical-loading-05-so-simple-mode/"  data-tooltip="简单的动态加载模式">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/01/android-dynamical-loading-03-so-in-sdcard/" data-tooltip="加载SD卡中的SO库">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Kaede Akatsuki. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/04/android-dynamical-loading-05-so-simple-mode/"  data-tooltip="简单的动态加载模式">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/01/android-dynamical-loading-03-so-in-sdcard/" data-tooltip="加载SD卡中的SO库">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar_01.png"/>
        
            <h4 id="about-card-name">Kaede Akatsuki</h4>
        
            <h5 id="about-card-bio"><p>中二病ANDROID魔法使い<br>兴趣是日本语、程序设计、萌产物<br>具体介绍可以参考 <a href="/about">About</a></p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>ANDROID開発</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                妖都
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('http://7xih5c.com1.z0.glb.clouddn.com/15-10-7/29875909.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-tu4ziscb5jrkjxubeugdgizktyuugflfq5jvgz4agzzmwifuq01g1lmq8giw.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/';
                 
                    this.page.identifier = '2016/06/04/android-dynamical-loading-04-so-problems/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'kidhaibara';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','oCoTxxFvwzZyiv48ioJ5','2.0.0');
    </script>


</html>
